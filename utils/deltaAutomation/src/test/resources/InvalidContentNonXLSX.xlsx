#!/bin/sh

if [[ $UID -ne 0 ]]; then
echo "This script needs to be run as root (with sudo)"
exit 1
fi

echo "If you are not using the default internet repositories you should configure this before running this script."
echo "You should also have an active network connection to the repositories."
read -p "Continue? [y/n]: " CONFIRM
if [ "$CONFIRM" != "y" ]; then
exit
fi

function promptPassphrase {
  PASS=""
  PASSCONF=""
  while [ -z "$PASS" ]; do
    read -s -p "Passphrase: " PASS
    echo ""
  done
  while [ -z "$PASSCONF" ]; do
    read -s -p "Confirm passphrase: " PASSCONF
    echo ""
  done
  echo ""
}

function getPassphrase {
  promptPassphrase
  while [ "$PASS" != "$PASSCONF" ]; do
    echo "Passphrases did not match, try again..."
    promptPassphrase
  done
}

echo -e "\n\nApplying recommended system settings...\n"

# Enable automatic updates
echo "APT::Periodic::Update-Package-Lists \"1\";
APT::Periodic::Unattended-Upgrade \"1\";
APT::Periodic::AutocleanInterval \"7\";
" >> /etc/apt/apt.conf.d/20auto-upgrades

chmod 644 /etc/apt/apt.conf.d/20auto-upgrades

# Disable apport (error reporting)
sed -ie '/^enabled=1$/ s/1/0/' /etc/default/apport

# Disable guest login
mkdir /etc/lightdm/lightdm.conf.d
echo "[SeatDefaults] allow-guest=false" > /etc/lightdm/lightdm.conf.d/50-no-guest.conf

# A hook to disable online scopes in dash on login
echo '#!/bin/bash' > /usr/local/bin/unity-privacy-hook.sh
echo "gsettings set com.canonical.Unity.Lenses remote-content-search 'none'
gsettings set com.canonical.Unity.Lenses disabled-scopes \"['more_suggestions-amazon.scope', 'more_suggestions-u1ms.scope', 'more_suggestions-populartracks.scope', 'music-musicstore.scope', 'more_suggestions-ebay.scope', 'more_suggestions-ubuntushop.scope', 'more_suggestions-skimlinks.scope']\"
for USER in \`ls -1 /home\`; do
chown \"\$USER\":\"\$USER\" /home/\"\$USER\"/.*
done
exit 0
" >> /usr/local/bin/unity-privacy-hook.sh
chmod 755 /usr/local/bin/unity-privacy-hook.sh
echo "[SeatDefaults]
session-setup-script=/usr/local/bin/unity-privacy-hook.sh" > /etc/lightdm/lightdm.conf.d/20privacy-hook.conf

# Refresh the package list
apt-get update

# Install extra packages
apt-get install -y apparmor-profiles apparmor-utils
apt-get install -y iptables-persistent

# Configure a basic IPv4 firewall
echo "*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
COMMIT" > /etc/iptables/rules.v4

# Configure a basic IPv6 firewall
echo "*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type 134 -j ACCEPT
-A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type 135 -j ACCEPT
-A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type 136 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
COMMIT" > /etc/iptables/rules.v6

# Load the above rule sets
service iptables-persistent start

# Set some AppArmor profiles to enforce mode
aa-enforce /etc/apparmor.d/usr.bin.firefox
aa-enforce /etc/apparmor.d/usr.sbin.avahi-daemon
aa-enforce /etc/apparmor.d/usr.sbin.dnsmasq
aa-enforce /etc/apparmor.d/bin.ping
aa-enforce /etc/apparmor.d/usr.sbin.rsyslogd


# Turn off privacy-leaking aspects of Unity
echo "user-db:user" > /etc/dconf/profile/user
echo "system-db:local" >> /etc/dconf/profile/user
mkdir -p /etc/dconf/db/local.d
echo "[com/canonical/unity/lenses]" > /etc/dconf/db/local.d/unity
echo "remote-content-search=false" >> /etc/dconf/db/local.d/unity
mkdir -p /etc/dconf/db/local.d/locks
echo "/com/canonical/unity/lenses/remote-content-search" > /etc/dconf/db/local.d/locks/unity
dconf update

# Make developer directory
mkdir -p ~/Applications/hmrc-development-environment/hmrc
echo 'export WORKSPACE=~/Applications/hmrc-development-environment/hmrc/' >> ~/.bashrc

# Upgrade the system
apt-get dist-upgrade -y

# Update repos
apt-get update

# Install OpenVPN network manager
sudo apt-get -y install network-manager-openvpn network-manager-openvpn-gnome

# Install build tools
sudo apt-get -y install build-essential libssl-dev libcurl4-gnutls-dev libexpat1-dev gettext unzip curl wget

# Add additional keys
sudo add-apt-repository -y ppa:webupd8team/java
sudo add-apt-repository -y ppa:git-core/ppa
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10
echo "deb http://repo.mongodb.org/apt/ubuntu "$(lsb_release -sc)"/mongodb-org/3.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-3.0.list
sudo apt-get update

# Install Java 8
sudo apt-get -y install oracle-java8-installer
echo 'export JAVA_HOME=/usr/lib/jvm/java-8-oracle' >> ~/.bashrc

# Install Git
sudo apt-get -y install git

# Install MongoDB
sudo apt-get -y install mongodb-org=3.0.5 mongodb-org-server=3.0.5 mongodb-org-shell=3.0.5 mongodb-org-mongos=3.0.5 mongodb-org-tools=3.0.5
echo "mongodb-org hold" | sudo dpkg --set-selections
echo "mongodb-org-server hold" | sudo dpkg --set-selections
echo "mongodb-org-shell hold" | sudo dpkg --set-selections
echo "mongodb-org-mongos hold" | sudo dpkg --set-selections
echo "mongodb-org-tools hold" | sudo dpkg --set-selections

# Install Scala
curl -LOk www.scala-lang.org/files/archive/scala-2.11.7.deb
sudo dpkg -i scala-2.11.7.deb
rm scala-2.11.7.deb

# Install SBT
curl -LOk http://dl.bintray.com/sbt/debian/sbt-0.13.8.deb
sudo dpkg -i sbt-0.13.8.deb
rm sbt-0.13.8.deb

echo -e "\nPOST INSTALLATION COMPLETE"

read -p "Reboot now? [y/n]: " CONFIRM
if [ "$CONFIRM" = "y" ]; then
reboot
fi